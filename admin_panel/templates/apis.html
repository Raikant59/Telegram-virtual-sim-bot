{% extends "base.html" %} {% block title %}Manage Connect APIs{% endblock %} {%
block content %}
<style>
  body {
    font-family: "Segoe UI", sans-serif;
    background: #f0f2f5;
    margin: 0;
  }
  header {
    background: linear-gradient(135deg, #2ecc71, #27ae60);
    color: #fff;
    padding: 20px;
    text-align: center;
    border-radius: 0 0 20px 20px;
  }
  main {
    max-width: 1000px;
    margin: auto;
    padding: 20px;
  }
  .card {
    background: #fff;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
  }
  .card h2 {
    margin: 0 0 15px;
    font-size: 20px;
    color: #333;
  }

  label {
    font-weight: 600;
    display: block;
    margin: 12px 0 6px;
    color: #444;
    font-size: 14px;
  }
  input,
  select,
  textarea {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #ccc;
    margin-bottom: 10px;
    font-size: 14px;
    background: #fafafa;
    transition: border 0.2s;
  }
  input:focus,
  select:focus,
  textarea:focus {
    border-color: #27ae60;
    outline: none;
    background: #fff;
  }
  textarea {
    resize: vertical;
    min-height: 60px;
  }
  button {
    background: #27ae60;
    color: #fff;
    padding: 10px 14px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.2s;
  }
  button:hover {
    background: #219150;
    transform: translateY(-1px);
  }
  .delete-btn {
    background: #e74c3c;
  }
  .delete-btn:hover {
    background: #c0392b;
  }

  .table-container {
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  th,
  td {
    border: 1px solid #eee;
    padding: 10px;
    white-space: nowrap;
    text-align: left;
  }
  th {
    background: #27ae60;
    color: #fff;
    font-weight: 600;
  }
  tr:nth-child(even) {
    background: #f9fafb;
  }

  .copy-text {
    cursor: pointer;
    text-decoration: underline;
  }
  .actions {
    display: flex;
    gap: 8px;
  }

  /* Stack rows on small screens */
  @media (max-width: 760px) {
    table,
    thead,
    tbody,
    th,
    td,
    tr {
      display: block;
    }
    thead {
      display: none;
    }
    tr {
      background: #fff;
      margin-bottom: 12px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    td {
      border: none;
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }
    td::before {
      content: attr(data-label);
      font-weight: 700;
      color: #555;
    }
    .actions {
      justify-content: flex-end;
    }
  }

  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    align-items: center;
    justify-content: center;
    z-index: 999;
    max-height: 90vh;      /* don't exceed 90% of viewport height */
  overflow-y: auto;      /* enable vertical scroll inside */

  }
  .modal-content {
    background: #fff;
    border-radius: 12px;
    width: 92%;
    max-width: 520px;
    padding: 20px;
    position: relative;
  }
  .close {
    position: absolute;
    right: 12px;
    top: 10px;
    font-size: 20px;
    cursor: pointer;
  }
</style>

<header><h1>üîå Manage Connect APIs</h1></header>
<main>
  <!-- Add API -->
  <div class="card">
    <h2>‚ûï Add API</h2>
    <form method="POST">
      <input type="hidden" name="action" value="add" />
      <label>API Name *</label>
      <input type="text" name="api_name" required placeholder="Example: 5sim" />

      <label>Server *</label>
      <select name="server_id" required>
        {% for server in servers %}
        <option value="{{ server.id }}">
          {{ server.name }} ({{ server.country }})
        </option>
        {% endfor %}
      </select>

      <div
        class="checkbox-row"
        style="display: flex; align-items: center; gap: 10px; margin: 12px 0">
        <input
          type="checkbox"
          id="use_headers"
          name="use_headers"
          style="width: auto" />
        <label for="use_headers" style="margin: 0; font-weight: 500"
          >Does your API use Authorization Headers?</label
        >
      </div>

      <div id="headers-wrapper" style="display: none">
        <label>Headers (comma separated key:value)</label>
        <textarea
          id="headers"
          name="headers"
          placeholder="Authorization: Bearer xxx, X-Api-Key: yyy"></textarea>
      </div>

      <label>Response Type</label>
      <select name="response_type">
        <option>Text</option>
        <option>JSON</option>
      </select>

      <label>Get Number URL *</label>
      <input
        type="url"
        name="get_number_url"
        required
        placeholder="https://api.myservice.com/getNumber" />

      <label>Get Status URL *</label>
      <input
        type="url"
        name="get_status_url"
        required
        placeholder="https://api.myservice.com/getStatus" />

      <label>Next Number URL</label>
      <input
        type="url"
        name="next_number_url"
        placeholder="https://api.myservice.com/nextNumber" />

      <label>Cancel URL</label>
      <input
        type="url"
        name="cancel_url"
        placeholder="https://api.myservice.com/cancel" />

      <label>Success Keyword</label>
      <input type="text" name="success_keyword" placeholder="E.g. STATUS_OK" />

      <label>Auto Cancel Time (minutes)</label>
      <input type="number" name="auto_cancel_time" value="5" />

      <label>Retry Time (seconds)</label>
      <input type="number" name="retry_time" value="0" />

      <button type="submit"><i class="fa-solid fa-save"></i> Save API</button>
    </form>
  </div>

  <!-- Current APIs -->
  <div class="card">
    <h2>üìã Current APIs</h2>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>API Name</th>
            <th>Server</th>
            <th>Response Type</th>
            <th>Get Number URL</th>
            <th>Get Status URL</th>
            <th>Next Number URL</th>
            <th>Cancel URL</th>
            <th>Success Keyword</th>
            <th>Auto Cancel</th>
            <th>Retry</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for api in apis %}
          <tr>
            <td data-label="API Name">{{ api.api_name }}</td>
            <td data-label="Server">{{ api.server.name }}</td>
            <td data-label="Response Type">{{ api.response_type }}</td>
            <td data-label="Get Number">
              <span class="copy-text" data-full="{{ api.get_number_url }}"
                >{{ api.get_number_url|truncate(20, True, '.') }}</span
              >
            </td>
            <td data-label="Get Status">
              <span class="copy-text" data-full="{{ api.get_status_url }}"
                >{{ api.get_status_url|truncate(20, True, '.') }}</span
              >
            </td>
            <td data-label="Next Number">
              <span class="copy-text" data-full="{{ api.next_number_url }}"
                >{{ api.next_number_url|truncate(20, True, '.') }}</span
              >
            </td>
            <td data-label="Cancel URL">
              <span class="copy-text" data-full="{{ api.cancel_url }}"
                >{{ api.cancel_url|truncate(20, True, '.') }}</span
              >
            </td>
            <td data-label="Success">{{ api.success_keyword }}</td>
            <td data-label="Auto Cancel">{{ api.auto_cancel_time }}</td>
            <td data-label="Retry">{{ api.retry_time }}</td>
            <td data-label="Actions">
              <div class="actions">
                <button type="button" onclick="openEdit('{{ api.id }}')">
                  <i class="fa-solid fa-pen"></i>
                </button>
                <form method="POST" style="display: inline">
                  <input type="hidden" name="action" value="delete" />
                  <input type="hidden" name="api_id" value="{{ api.id }}" />
                  <button type="submit" class="delete-btn">
                    <i class="fa-solid fa-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>

          <!-- Hidden payload for prefill -->
          <script type="application/json" id="api-json-{{ api.id }}">
            {{ {
              "id": api.id|string,
              "api_name": api.api_name,
              "server_id": (api.server.id|string) if api.server else "",
              "use_headers": api.use_headers,
              "headers": "{% for h in api.headers %}{{ h.key }}: {{ h.value }}{% if not loop.last %}, {% endif %}{% endfor %}",
              "response_type": api.response_type,
              "get_number_url": api.get_number_url,
              "get_status_url": api.get_status_url,
              "next_number_url": api.next_number_url,
              "cancel_url": api.cancel_url,
              "success_keyword": api.success_keyword,
              "auto_cancel_time": api.auto_cancel_time or 5,
              "retry_time": api.retry_time or 0
            }|tojson|safe }}
          </script>

          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</main>

<!-- Edit Modal -->
<div class="modal" id="editModal">
  <div class="modal-content">
    <span class="close" onclick="closeEdit()">&times;</span>
    <h2 id="editTitle">‚úèÔ∏è Edit API</h2>
    <form method="POST" id="editForm">
      <input type="hidden" name="action" value="edit" />
      <input type="hidden" name="api_id" id="e_api_id" />

      <label>API Name *</label>
      <input type="text" name="api_name" id="e_api_name" required />

      <label>Server *</label>
      <select name="server_id" id="e_server_id" required>
        {% for server in servers %}
        <option value="{{ server.id }}">
          {{ server.name }} ({{ server.country }})
        </option>
        {% endfor %}
      </select>

      <div
        style="display: flex; align-items: center; gap: 10px; margin: 12px 0">
        <input
          type="checkbox"
          id="e_use_headers"
          name="use_headers"
          style="width: auto" />
        <label for="e_use_headers" style="margin: 0; font-weight: 500"
          >Use Headers</label
        >
      </div>

      <div id="e_headers_wrap" style="display: none">
        <label>Headers (comma separated key:value)</label>
        <textarea name="headers" id="e_headers"></textarea>
      </div>

      <label>Response Type</label>
      <select name="response_type" id="e_response_type">
        <option>Text</option>
        <option>JSON</option>
      </select>

      <label>Get Number URL *</label>
      <input type="url" name="get_number_url" id="e_get_number_url" required />

      <label>Get Status URL *</label>
      <input type="url" name="get_status_url" id="e_get_status_url" required />

      <label>Next Number URL</label>
      <input type="url" name="next_number_url" id="e_next_number_url" />

      <label>Cancel URL</label>
      <input type="url" name="cancel_url" id="e_cancel_url" />

      <label>Success Keyword</label>
      <input type="text" name="success_keyword" id="e_success_keyword" />

      <label>Auto Cancel Time (minutes)</label>
      <input
        type="number"
        name="auto_cancel_time"
        id="e_auto_cancel_time"
        value="5" />

      <label>Retry Time (seconds)</label>
      <input type="number" name="retry_time" id="e_retry_time" value="0" />

      <button type="submit"><i class="fa-solid fa-save"></i> Update</button>
    </form>
  </div>
</div>

<script>
  const useHeadersCheckbox = document.getElementById("use_headers");
  const headersWrapper = document.getElementById("headers-wrapper");
  if (useHeadersCheckbox) {
    useHeadersCheckbox.addEventListener("change", function () {
      headersWrapper.style.display = this.checked ? "block" : "none";
    });
  }

  document.querySelectorAll(".copy-text").forEach((el) => {
    el.addEventListener("click", () => {
      const fullUrl = el.dataset.full;
      navigator.clipboard.writeText(fullUrl);
    });
  });

  function openEdit(id) {
    const raw = document.getElementById(`api-json-${id}`).textContent;
    const data = JSON.parse(raw);

    document.getElementById("e_api_id").value = data.id || "";
    document.getElementById("e_api_name").value = data.api_name || "";
    document.getElementById("e_server_id").value = data.server_id || "";
    document.getElementById("e_use_headers").checked = !!data.use_headers;

    const wrap = document.getElementById("e_headers_wrap");
    wrap.style.display = data.use_headers ? "block" : "none";
    document.getElementById("e_headers").value = data.headers || "";

    document.getElementById("e_response_type").value =
      data.response_type || "Text";
    document.getElementById("e_get_number_url").value =
      data.get_number_url || "";
    document.getElementById("e_get_status_url").value =
      data.get_status_url || "";
    document.getElementById("e_next_number_url").value =
      data.next_number_url || "";
    document.getElementById("e_cancel_url").value = data.cancel_url || "";
    document.getElementById("e_success_keyword").value =
      data.success_keyword || "";
    document.getElementById("e_auto_cancel_time").value =
      data.auto_cancel_time ?? 5;
    document.getElementById("e_retry_time").value = data.retry_time ?? 0;

    document.getElementById("editModal").style.display = "flex";
  }

  function closeEdit() {
    document.getElementById("editModal").style.display = "none";
  }

  // toggle inside modal
  document
    .getElementById("e_use_headers")
    .addEventListener("change", function () {
      document.getElementById("e_headers_wrap").style.display = this.checked
        ? "block"
        : "none";
    });

  window.addEventListener("click", (e) => {
    if (e.target === document.getElementById("editModal")) closeEdit();
  });
</script>
{% endblock %}
